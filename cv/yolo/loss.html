
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Loss Function &#8212; Study Notes  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Reference" href="reference.html" />
    <link rel="prev" title="YOLO" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../index.html">
<p class="title">Study Notes</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../nlp/index.html">
  NLP
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Computer Vision
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/ppmzhang2/" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this site..." aria-label="Search this site..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../nerf/index.html">
   NeRF
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../nerf/model.html">
     Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../nerf/reference.html">
     Reference
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   YOLO
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Loss Function
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="reference.html">
     Reference
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../reference.html">
   Reference
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#notation">
   Notation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#formula">
   Formula
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reference">
   Reference
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="loss-function">
<h1>Loss Function<a class="headerlink" href="#loss-function" title="Permalink to this headline">#</a></h1>
<section id="notation">
<h2>Notation<a class="headerlink" href="#notation" title="Permalink to this headline">#</a></h2>
<p>The YOLO algorithm assumes that the model divides an input image into an
<span class="math notranslate nohighlight">\(S \times S\)</span> grid.
Each grid cell is responsible to predict <span class="math notranslate nohighlight">\(B\)</span> bounding boxes, performing both
localization and classification (totally <span class="math notranslate nohighlight">\(K\)</span> classes).</p>
<p>This implementation <a class="footnote-reference brackets" href="#f01" id="id1">1</a> assumes for labels that each cell has <strong>only one</strong>
ground truth box.</p>
<ul>
<li><p>Predictions of each <strong>bounding box</strong>:</p>
<div class="math notranslate nohighlight">
\[\mathbf{y}^{(box)} = ( x, y, w, h, p^{(obj)} )^T\]</div>
<ul>
<li><p><span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span>: coordinates of the object center. <span class="math notranslate nohighlight">\(x, y \in (0, 1)\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(w\)</span> and <span class="math notranslate nohighlight">\(h\)</span>: width and height of the object <span class="math notranslate nohighlight">\(w, h &gt; 0\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(p^{(obj)}\)</span>: confidence that the box contains an object.
Its label value can only be either <span class="math notranslate nohighlight">\(1\)</span> or <span class="math notranslate nohighlight">\(0\)</span>. Yet the target value for
training could be different. According to the paper <a class="footnote-reference brackets" href="#f02" id="id2">2</a>:</p>
<blockquote>
<div><p>If no pred object exists in that cell, the confidence scores should be
zero.
Otherwise we want the confidence score to equal the intersection over
union (IOU) between the predicted box and the ground truth.</p>
</div></blockquote>
<p>Thus the target confidence could only be either <span class="math notranslate nohighlight">\(0\)</span> (no object in that
cell) or the <span class="math notranslate nohighlight">\(IoU\)</span> value.
Suppose <span class="math notranslate nohighlight">\(x_{i}\)</span>, <span class="math notranslate nohighlight">\(y_{i}\)</span>, <span class="math notranslate nohighlight">\(w_{i}\)</span>, <span class="math notranslate nohighlight">\(h_{i}\)</span> are the ground truth coordinates
of the <span class="math notranslate nohighlight">\(i\)</span> th grid cell, the <span class="math notranslate nohighlight">\(IoU\)</span> of the <span class="math notranslate nohighlight">\(j\)</span> th predicted bounding box of
the <span class="math notranslate nohighlight">\(i\)</span> th cell is:</p>
<div class="math notranslate nohighlight">
\[IoU_{ij} =
\frac
  { Area(x_{i}, y_{i}, w_{i}, h_{i}) \cap
    Area(\hat{x}_{ij}, \hat{y}_{ij}, \hat{w}_{ij}, \hat{h}_{ij})
  }
  { Area(x_{i}, y_{i}, w_{i}, h_{i}) \cup
    Area(\hat{x}_{ij}, \hat{y}_{ij}, \hat{w}_{ij}, \hat{h}_{ij})
  }\]</div>
</li>
</ul>
</li>
<li><p>Classification of each <strong>cell</strong> (regardless of the number of boxes <span class="math notranslate nohighlight">\(B\)</span>)</p>
<div class="math notranslate nohighlight">
\[\mathbf{y}^{(cls)} =
  ( p^{(cls | obj)} (1),
    p^{(cls | obj)} (2),
    \ldots,
    p^{(cls | obj)} (K)
  )^T\]</div>
</li>
<li><p>Output / label:</p>
<div class="math notranslate nohighlight">
\[\mathbf{y}_i =
  ( \mathbf{y}_{i1}^{(box)},
    \mathbf{y}_{i2}^{(box)},
    \ldots,
    \mathbf{y}_{iB}^{(box)},
    \mathbf{y}_i^{(cls)}
  )\]</div>
<p>where <span class="math notranslate nohighlight">\(i \in \mathbb{N}, i &lt; S^2\)</span>.</p>
</li>
</ul>
</section>
<section id="formula">
<h2>Formula<a class="headerlink" href="#formula" title="Permalink to this headline">#</a></h2>
<p>Original loss function:</p>
<div class="math notranslate nohighlight">
\[\begin{split}L(\mathbf{y}, \mathbf{\hat{y}}) =
  \lambda_{coord} \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{obj}
  [ (x_{i} - \hat{x}_{i})^2 + (y_{i} - \hat{y}_{i})^2
  ]
\\
+ \lambda_{coord} \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{obj}
  [ (\sqrt{w_{i}} - \sqrt{\hat{w}_{i}})^2 +
    (\sqrt{h_{i}} - \sqrt{\hat{h}_{i}})^2
  ]
\\
+ \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{obj}
  (C_{i} - \hat{C}_{i})^2
\\
+ \lambda_{noobj} \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{noobj}
  (C_{i} - \hat{C}_{i})^2
\\
+ \sum_{i=0}^{S^2} \mathbb{1}_{i}^{obj} \sum_{c \in classes}
  (p_i (c) - \hat{p}_i (c))^2\end{split}\]</div>
<p>can be re-written as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}L(\mathbf{y}, \mathbf{\hat{y}}) =
  \lambda_{coord} \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{obj}
  [ (x_{i} - \hat{x}_{ij})^2 +
    (y_{i} - \hat{y}_{ij})^2
  ]
\\
+ \lambda_{coord} \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{obj}
  [ (\sqrt{w_{i}} - \sqrt{\hat{w}_{ij}})^2 +
    (\sqrt{h_{i}} - \sqrt{\hat{h}_{ij}})^2
  ]
\\
+ \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{ij}^{obj}
  (IoU_{ij} - \hat{p}_{ij}^{(obj)})^2
\\
+ \lambda_{noobj} \sum_{i=0}^{S^2} \sum_{j=0}^{B} \mathbb{1}_{i}^{noobj}
  (0 - \hat{p}_{ij}^{(obj)})^2
\\
+ \sum_{i=0}^{S^2} \mathbb{1}_{i}^{obj} \sum_{k=1}^{K}
  (p_i^{(cls | obj)} (k) - \hat{p}_i^{(cls | obj)} (k))^2\end{split}\]</div>
<p>where</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\mathbb{1}_{i}^{obj}\)</span> is label determined:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbb{1}_{i}^{obj} =
\begin{cases}
  1 &amp; p_i^{(obj)} = 1
  \\
  0 &amp; otherwise
\end{cases},\end{split}\]</div>
</li>
<li><p><span class="math notranslate nohighlight">\(\mathbb{1}_{i}^{noobj}\)</span> is label determined:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbb{1}_{i}^{noobj} =
\begin{cases}
  1 &amp; p_i^{(obj)} = 0
  \\
  0 &amp; otherwise
\end{cases},\end{split}\]</div>
</li>
<li><p><span class="math notranslate nohighlight">\(\mathbb{1}_{ij}^{obj}\)</span> is a bit complicated. According to the paper <a class="footnote-reference brackets" href="#f02" id="id3">2</a>:</p>
<blockquote>
<div><p>… denotes that the <span class="math notranslate nohighlight">\(j\)</span> th bounding box predictor in cell <span class="math notranslate nohighlight">\(i\)</span> is
“responsible” for that prediction.</p>
</div></blockquote>
<p>that is to say, is <span class="math notranslate nohighlight">\(1\)</span> if there is an object in cell <span class="math notranslate nohighlight">\(i\)</span> and confidence of
the <span class="math notranslate nohighlight">\(j\)</span> th bounding box has the highest <span class="math notranslate nohighlight">\(IoU\)</span> with the cell’s ground truth.</p>
</li>
<li><p><span class="math notranslate nohighlight">\(\lambda_{coord} = 5\)</span> to increase the localization prediction error</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda_{noobj} = 0.5\)</span> to decrease the loss from confidence predictions
containing no object</p></li>
</ul>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">#</a></h2>
<dl class="footnote brackets">
<dt class="label" id="f01"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/motokimura/yolo_v1_pytorch">https://github.com/motokimura/yolo_v1_pytorch</a></p>
</dd>
<dt class="label" id="f02"><span class="brackets">2</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id3">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://arxiv.org/abs/1506.02640">https://arxiv.org/abs/1506.02640</a></p>
</dd>
</dl>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">YOLO</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="reference.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reference</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, ZHANG, Meng.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>